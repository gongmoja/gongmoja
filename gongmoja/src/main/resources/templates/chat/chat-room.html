<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Chat Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
</head>
<body>
<main class="flex-shrink-0">
  <section class="py-5">
    <div class="container px-5">
      <h1 class="text-center mb-5" th:text="'Chat Room - ' + ${chatRoomId}"></h1>
      <div class="chat-box" id="chat-box" data-chat-room-id="${chatRoomId}">
        <!-- 채팅 내용을 표시할 박스 -->
      </div>
      <div class="message-box" style="display: block;">
        <input type="text" class="form-control" id="messageInput" placeholder="메시지를 입력하세요">
        <button class="btn btn-primary" id="connectButton">연결하기</button>
        <button class="btn btn-primary" id="sendButton" disabled>보내기</button>
      </div>
    </div>
  </section>
</main>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa" crossorigin="anonymous"></script>
<script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
<script>
  const websocket = new WebSocket(`ws://${window.location.host}/ws/chat`);
  const stompClient = Stomp.over(websocket);

  const connectButton = document.getElementById('connectButton');
  const sendButton = document.getElementById('sendButton');
  const messageInput = document.getElementById('messageInput');

  connectButton.addEventListener('click', () => {
    stompClient.connect({}, (frame) => {
      console.log(`WebSocket connected for chat room!`);

      stompClient.subscribe(`/sub/chatroom/1`, (message) => {
        const messageBody = JSON.parse(message.body);
        const chatBox = document.getElementById('chat-box');
        const newMessage = document.createElement('p');
        newMessage.textContent = messageBody.content;
        chatBox.appendChild(newMessage);
      });

      sendButton.disabled = false; // "보내기" 버튼 활성화
    });

    connectButton.disabled = true; // "연결하기" 버튼 비활성화
  });

  sendButton.addEventListener('click', () => {
    const message = messageInput.value;
    if (message.trim() === '') {
      return;
    }

    const chatMessage = {
      sender: 'You', // 발신자 정보 설정
      content: message,
    };

    stompClient.send(`/pub/chat`, {}, JSON.stringify(chatMessage));
    messageInput.value = '';
  });
</script>
</body>
</html>
